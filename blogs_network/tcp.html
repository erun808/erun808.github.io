<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TCP总结 | Erun&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog-solid.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.64f7ac41.css" as="style"><link rel="preload" href="/assets/js/app.046e486f.js" as="script"><link rel="preload" href="/assets/js/2.cb9b70d5.js" as="script"><link rel="preload" href="/assets/js/3.060301bd.js" as="script"><link rel="prefetch" href="/assets/js/10.65033b73.js"><link rel="prefetch" href="/assets/js/11.dc480957.js"><link rel="prefetch" href="/assets/js/12.dc9b98bc.js"><link rel="prefetch" href="/assets/js/13.20427e1b.js"><link rel="prefetch" href="/assets/js/14.c7574273.js"><link rel="prefetch" href="/assets/js/15.c9f6396d.js"><link rel="prefetch" href="/assets/js/16.dd8e599b.js"><link rel="prefetch" href="/assets/js/4.d3a55895.js"><link rel="prefetch" href="/assets/js/5.15d4190c.js"><link rel="prefetch" href="/assets/js/6.18bcac4b.js"><link rel="prefetch" href="/assets/js/7.99688cf1.js"><link rel="prefetch" href="/assets/js/8.4e9db8b3.js"><link rel="prefetch" href="/assets/js/9.4450ef0b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.64f7ac41.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo2.png" alt="Erun's Blog" class="logo"> <span class="site-name can-hide">Erun's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blogs" class="dropdown-title"><span class="title">Blogs</span> <span class="arrow down"></span></button> <button type="button" aria-label="Blogs" class="mobile-dropdown-title"><span class="title">Blogs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs_ES6/Promise浅析.html" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/blogs_network/tcp.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/blogs_works/uploadFile.html" class="nav-link">
  业务相关
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/erun808" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blogs" class="dropdown-title"><span class="title">Blogs</span> <span class="arrow down"></span></button> <button type="button" aria-label="Blogs" class="mobile-dropdown-title"><span class="title">Blogs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs_ES6/Promise浅析.html" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/blogs_network/tcp.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/blogs_works/uploadFile.html" class="nav-link">
  业务相关
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/erun808" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>计算机网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs_network/tcp.html" aria-current="page" class="active sidebar-link">TCP总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tcp总结"><a href="#tcp总结" class="header-anchor">#</a> TCP总结</h1> <p>TCP协议比较复杂，这一篇博客作为笔记，记录TCP中比较重要且容易忘记的点。</p> <h3 id="_1、tcp报文段的首部"><a href="#_1、tcp报文段的首部" class="header-anchor">#</a> 1、TCP报文段的首部</h3> <p>TCP虽然是面向字节流的，但TCP传送的数据单元却是报文段。一个TCP报文段分为首部和数据两部分，而TCP的全部功能都体现在它的首部各字段发挥的作用中。首先引入一张<a href="https://baike.baidu.com/item/%E8%B0%A2%E5%B8%8C%E4%BB%81/6146871?fr=aladdin" target="_blank" rel="noopener noreferrer">谢希任<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>教授所著的《计算机网络（第7版）》(下文称为书本) 中的TCP首部插图：</p> <p><img src="/assets/img/tcp_head.c8265437.png" alt="TCP首部"></p> <p>上图已经很清晰的展示了TCP首部中的所有字段的基本信息了，其中主要的几个字段有：<strong>序号（也叫序列号，通常记为seq）、确认号（通常记为ack）、6个标志位、窗口</strong>，这几个字段的作用如下：<br>
⭐️<strong>序号</strong>：占4个字节，用来标记报文段的顺序，TCP把连接中发送的所有数据字节都编上一个序号，<strong>第一个字节的编号由本地随机产生</strong>；给字节编上序号后，就给每一个报文段指派一个序号；序列号seq就是这个报文段中的第一个字节的数据编号。<br>
⭐️<strong>确认号</strong>：占4个字节，表示期待收到对方下一个报文段的第一个数据字节的序号；由于序号表示报文段携带数据的第一个字节的编号，而确认号指的是期望接收到的下一个字节的编号，<strong>因此当前报文段最后一个字节的编号+1即为确认号</strong>。<br>
⭐️<strong>6个标志位</strong>：每个标志位占1位，取值是0或1，主要注意这3个标志位：</p> <ul><li><strong><code>确认位ACK</code></strong>：仅当ACK=1时，确认号字段才有效。ACK=0时，确认号无效</li> <li><strong><code>同步位SYN</code></strong>：连接建立时用于同步序号。当SYN=1，ACK=0时表示：这是一个连接请求报文段。若同意连接，则在响应报文段中使得SYN=1，ACK=1。因此，SYN=1表示这是一个连接请求，或连接接受报文。SYN这个标志位只有在TCP建产连接时才会被置1，握手完成后SYN标志位被置0。</li> <li><strong><code>终止位FIN</code></strong>：用来释放一个连接。FIN=1表示：此报文段的发送方的数据已经发送完毕，并要求释放TCP连接。</li> <li>用表格描述是如下：
<table><thead><tr><th style="text-align:center;">字段</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:center;">ACK</td> <td style="text-align:left;">确认号是否有效，一般置为1。</td></tr> <tr><td style="text-align:center;">SYN</td> <td style="text-align:left;">请求建立连接，并在其序列号的字段进行序列号的初始值设定。建立连接，设置为1</td></tr> <tr><td style="text-align:center;">FIN</td> <td style="text-align:left;">希望断开连接。</td></tr></tbody></table></li></ul> <p>⭐️<strong>窗口</strong>：占2个字节，指的是发送本报文的段的一方的接收窗口，也就是对方接收到本报文段后能发送的数据量，这个字段是动态变化的。</p> <h3 id="_2、三握四挥"><a href="#_2、三握四挥" class="header-anchor">#</a> 2、三握四挥</h3> <p>TCP是面向连接的，其经典的三次握手建立连接和四次挥手断开连接也是比较重要的。</p> <p>🌔<strong>三次握手</strong><br>
TCP的连接建立采用客户服务器方式，主动发起连接的请求的应用进程叫做客户，被动等待连接的应用进程叫做服务器。建立连接的过程叫做握手。再次引用书本中关于三次握手过程的插图：</p> <p><img src="/assets/img/threeHand.ac6e5101.png" alt="三次握手"></p> <p>根据上图可描述出三次握手的过程：<br>
🤝第一次握手：<strong>客户端进程向服务器进程发送连接请求报文段</strong>（此时首部中的同步位SYN = 1，序号是随机产生的一个初始序号seq = x。此报文段是SYN报文段），并进入SYN_SENT（<strong>同步已发送</strong>）状态，等待服务器确认。<br>
🤝第二次握手：<strong>服务器进程收到连接请求后</strong>，如果同意（<font color="orange">不同意可能是服务器对应端口未打开？</font>）的话就<strong>向客户端发送确认报文段</strong>（此时首部中SYN位和ACK位都置1，确认号ack = x + 1则表明收到了客户端的请求，同时随机生成一个初始序号seq = y。此报文段既是SYN报文段，也是ACK报文段），发送完后<strong>服务器进程</strong>进入SYN-RCVD(<strong>同步收到</strong>)状态。<br> <font color="green">注意：前2次握手都是不能携带数据的，但都要且仅要消耗一个序号。</font><br>
🤝  <strong>客户端收到服务器的确认后</strong>，还要向服务器<strong>发送确认报文段</strong>（此时首部中的ACK位置1，序号就是seq = x + 1，确认号ack = y + 1。此报文段是ACK报文段），此报文段是允许携带数据的。客户端发送完确认报文段后就进入了ESTABLISHED（<strong>已建立连接</strong>）状态，服务器接收到客户端的确认后也进入ESTABLISHED（<strong>已建立连接</strong>）状态。<br>
至此连接就建立了。
<font color="green">上图中服务器进程的CLOSED(关闭)状态其实是表示该服务器进程未被分配端口，分配端口后该进程就会变为且一直处于LISTEN(监听)状态。</font></p> <p>🌔<strong>四次挥手</strong><br>
在数据传输结束后，通信双方都可以释放连接。依然引用书本中关于TCP连接释放的插图：<br> <img src="/assets/img/fourHand.e1d78216.png" alt="四次挥手"><br>
✋第一次挥手：<strong>客户端进程发出连接释放报文段</strong>，并且停止发送数据。释放数据报文首部中终止控制位FIN=1，其序号为seq=u（等于前面已经传送过来的数据的最后一个字节的序号加1），此时，<strong>客户端进程</strong>进入FIN-WAIT-1（<strong>终止等待1</strong>）状态。 TCP规定，FIN报文段即使不携带数据，也要消耗一个序号。<br>
✋第二次挥手：<strong>服务器进程接收到连接释放报文段后即发出确认</strong>，确认号ack=u+1，并且带上自己的序列号seq=v，此时，<strong>服务器进程</strong>就进入了CLOSE-WAIT（<strong>关闭等待</strong>）状态，客户端没有数据要发送了，但服务器任可以发送数据。<strong>客户端进程接收到服务器进程的确认后</strong>，就进入FIN-WAIT-2（<strong>终止等待2</strong>）状态。<br> <font color="green">此时从客户端到服务器这个方向的连接就已经释放了，TCP连接处于半关闭状态。</font><br>
✋第三次挥手：若<strong>服务器进程</strong>没有要向客户端进程发送数据了，则<strong>发出连接释放报文段</strong>（FIN=1），报文段首部中要重复上次已经发送过的确认号ack=u+1，由于在半关闭状态服务器很可能又发送了一些数据，假定此时的序列号为seq=w。此时，<strong>服务器进程</strong>就进入了LAST-ACK（<strong>最后确认</strong>）状态，等待客户端的确认。<br>
✋第四次挥手：<strong>客户端进程收到服务器进程的连接释放报文后</strong>，必须<strong>发出确认报文段</strong>，报文段首部中确认位ACK=1，确认号ack=w+1，而序号是seq=u+1，此时，<strong>客户端进程</strong>就进入了TIME-WAIT（<strong>时间等待</strong>）状态。注意此时TCP连接还没有释放，必须<strong>经过2MSL（最长报文段寿命）的时间后，客户端</strong>撤销相应的TCB（传输控制块）后，才进入CLOSED（<strong>关闭</strong>）状态。而<strong>服务器只要收到了客户端发出的确认</strong>，就立即进入CLOSED（<strong>关闭</strong>）状态<br> <font color="green">可以看到，服务器结束TCP连接的时间要比客户端早一些。</font></p> <p>⚠️关于三次握手和四次挥手的常见问题可参考书本和其他<a href="https://blog.csdn.net/qq_38950316/article/details/81087809?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.base&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.base" target="_blank" rel="noopener noreferrer">博客<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="_3、可靠传输的原理和实现-待续"><a href="#_3、可靠传输的原理和实现-待续" class="header-anchor">#</a> 3、可靠传输的原理和实现（待续）</h3> <ul><li>停止等待协议</li> <li>连续ARQ协议</li> <li>流量控制（滑动窗口）</li> <li>拥塞控制（慢开始、拥塞避免、快重传、快恢复）</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.046e486f.js" defer></script><script src="/assets/js/2.cb9b70d5.js" defer></script><script src="/assets/js/3.060301bd.js" defer></script>
  </body>
</html>
