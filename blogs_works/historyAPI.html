<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>H5使用History API实现页面拦截 | Erun&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog-solid.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.64f7ac41.css" as="style"><link rel="preload" href="/assets/js/app.046e486f.js" as="script"><link rel="preload" href="/assets/js/2.cb9b70d5.js" as="script"><link rel="preload" href="/assets/js/4.d3a55895.js" as="script"><link rel="prefetch" href="/assets/js/10.65033b73.js"><link rel="prefetch" href="/assets/js/11.dc480957.js"><link rel="prefetch" href="/assets/js/12.dc9b98bc.js"><link rel="prefetch" href="/assets/js/13.20427e1b.js"><link rel="prefetch" href="/assets/js/14.c7574273.js"><link rel="prefetch" href="/assets/js/15.c9f6396d.js"><link rel="prefetch" href="/assets/js/16.dd8e599b.js"><link rel="prefetch" href="/assets/js/3.060301bd.js"><link rel="prefetch" href="/assets/js/5.15d4190c.js"><link rel="prefetch" href="/assets/js/6.18bcac4b.js"><link rel="prefetch" href="/assets/js/7.99688cf1.js"><link rel="prefetch" href="/assets/js/8.4e9db8b3.js"><link rel="prefetch" href="/assets/js/9.4450ef0b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.64f7ac41.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo2.png" alt="Erun's Blog" class="logo"> <span class="site-name can-hide">Erun's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blogs" class="dropdown-title"><span class="title">Blogs</span> <span class="arrow down"></span></button> <button type="button" aria-label="Blogs" class="mobile-dropdown-title"><span class="title">Blogs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs_ES6/Promise浅析.html" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/blogs_network/tcp.html" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/blogs_works/uploadFile.html" class="nav-link">
  业务相关
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/erun808" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blogs" class="dropdown-title"><span class="title">Blogs</span> <span class="arrow down"></span></button> <button type="button" aria-label="Blogs" class="mobile-dropdown-title"><span class="title">Blogs</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blogs_ES6/Promise浅析.html" class="nav-link">
  ES6
</a></li><li class="dropdown-item"><!----> <a href="/blogs_network/tcp.html" class="nav-link">
  网络
</a></li><li class="dropdown-item"><!----> <a href="/blogs_works/uploadFile.html" class="nav-link">
  业务相关
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/erun808" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>探究业务功能实现的原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blogs_works/uploadFile.html" class="sidebar-link">前端文件上传</a></li><li><a href="/blogs_works/historyAPI.html" aria-current="page" class="active sidebar-link">H5使用History API实现页面拦截</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="h5使用history-api实现页面拦截"><a href="#h5使用history-api实现页面拦截" class="header-anchor">#</a> H5使用History API实现页面拦截</h1> <h3 id="_1、需求"><a href="#_1、需求" class="header-anchor">#</a> 1、需求</h3> <p>开发H5时可能会遇到这样的需求：在触发页面返回（或退出当前网站）时弹出弹窗告知用户是否确定退出，并显示一些信息或警告，这里的 <strong>“触发返回”</strong> 可以是实体按键返回、手势操作返回或者点击浏览器的返回按钮。为了实现这个需求，我首先想到的是Vue中的路由守卫，在页面路由发生改变时将跳转路径设置为当前路径（也就是页面不变），再根据判断决定是否出现弹窗（未实践过），不过由于开发项目使用的uni-app框架，它不支持Vue的路由守卫（虽然有第三方插件可以实现），所以最终我选择用原生的方法，也就是使用HTML5更新的History API来实现这一需求。</p> <h3 id="_2、实现思路"><a href="#_2、实现思路" class="header-anchor">#</a> 2、实现思路</h3> <p>了解HIstory API之前，先明确一下实现这一需求2个问题：<br>
1️⃣ 如果是从浏览器输入地址进入网站，且这是一个只有一个页面的网站，那么在移动端触发返回时会直接退出整个网站（这在PC端的浏览器中相当于点击标签页的关闭按钮），需要在退出前拦截页面，然后显示弹窗，那是否有事件能阻止页面的关闭呢？确实是有的，那就是全局对象 <code>window</code>上的 <strong><code>beforeunload</code></strong> 事件，这是MDN文档中对于  <strong><code>beforeunload</code></strong> 事件的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/beforeunload_event" target="_blank" rel="noopener noreferrer">介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <blockquote><p>当浏览器窗口关闭或者刷新时，会触发beforeunload事件。当前页面不会直接关闭，可以点击确定按钮关闭或刷新，也可以取消关闭或刷新。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeunload'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Cancel the event as stated by the standard.</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Chrome requires returnValue to be set.</span>
    event<span class="token punctuation">.</span>returnValue <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
</code></pre></div><p>使用上面的代码就可以实现在PC端点击标签页的关闭按钮时弹出模态框，选择确认关闭网页，选择取消留在本页。但我在Chrome浏览器中测试发现并不是每次都会弹出模态框，有时会直接关闭或刷新，且MDN文档中也说明了此方法的兼容性不是很好，再考虑到这种方法实现上面的需求只能弹出浏览器默认的模态框（除非重写<code>window.confirm()</code>，当然很少人会这么做），所以我没有使用这种方法来实现需求，也没有进行移动端的测试。下图是我打开同一个 <code>test.html</code> 文件（使用了上面的代码）的2个页面，可以看到一个标签页可以触发 <strong><code>beforeunload</code></strong> 事件，另一个不可以。</p> <p><img src="/assets/img/beforeunload.ee1319da.gif" alt="测试1">
2️⃣ 如果是有多个页面的网站，也就是需要弹窗的页面是从本网站的另一页面跳转过来的，那在触发返回时会直接跳到上一页，那如果上一页跟当前页相同，那不就看起来像是没跳转一样了？所以如果可以在进入当前页面时在浏览器的历史记录栈中添加多一条当前页面的记录，并把指针指向栈顶，那么在后退的时显示的内容还是和当前页相同，然后只要监听页面后退或页面出栈（栈中指针的变化）的事件就可以弹出弹窗。History API正好能满足这些需求。</p> <h3 id="_3、history-api"><a href="#_3、history-api" class="header-anchor">#</a> 3、History API</h3> <p>按照惯例先看一下MDN文档对History API的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/History_API" target="_blank" rel="noopener noreferrer">介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <blockquote><p>DOM window 对象通过 history 对象提供了对浏览器的会话历史的访问(不要与 WebExtensions history搞混了)。它暴露了很多有用的方法和属性，允许你在用户浏览历史中向前和向后跳转，同时——从HTML5开始——提供了对history栈中内容的操作。</p></blockquote> <p>通过MDN文档可以知道，要实现在浏览器的历史记录栈中添加条目，需要使用 <code>history.pushState()</code> 方法，而监听历史记录栈中当前指针的变化则是要用到 <code>popstate</code> 事件。<code>history.pushState()</code> 方法接收三个参数，第一个参数用于存储该url对应的状态对象，该对象可在 <code>popstate</code> 事件中获取，也可在history对象中获取。第二个参数是标题，目前浏览器并未实现。第三个参数则是设定的url，一般设置为相对路径，如果设置为绝对路径时需要保证同源。当活动历史记录条目更改时，将触发 <code>popstate</code> 事件，这里的活动记录条目更改可由浏览器动作或JavaScript代码触发，也就是用户点击浏览器回退（前进）按钮或者在代码中调用 <code>history.back()</code> 或者 <code>history.forward()</code>方法进行触发，需要注意的是调用 <code>history.pushState()</code> 本身不会触发 <code>popstate</code> 事件。更多详细信息请见<a href="https://developer.mozilla.org/zh-CN/docs/Web/APIHistory_API#%E6%B7%BB%E5%8A%A0%E5%92%8C%E4%BF%AE%E6%94%B9%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E4%B8%AD%E7%9A%84%E6%9D%A1%E7%9B%AE" target="_blank" rel="noopener noreferrer">MDN文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。简单示例代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>pushState<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>跳转<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#btn'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> btn2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#btn2'</span><span class="token punctuation">)</span>
    btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'title'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'bar.html'</span> <span class="token punctuation">}</span>
        window<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> state<span class="token punctuation">.</span>title<span class="token punctuation">,</span> state<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    btn2<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'https://www.baidu.com'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'popstate!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面代码会在点击<kbd>pushState按钮</kbd>时往浏览器历史记录栈压入一条记录，原来的<code>test.html</code> 页面将变为 <code>bar.html</code> 页面，然后再点击浏览器回退按钮时会跳回 <code>test.html</code> 页面，跳转结束后会弹出警告框（以上操作都不会刷新页面）。在 <code>bar.html</code> 页面点击<kbd>跳转按钮</kbd>则会刷新页面并跳到百度首页，再返回时会回到 <code>test.html</code> 页面。下图是测试结果：</p> <p><img src="/assets/img/historyApi.5eca43d0.gif" alt="historyApi">
History API目前没有提供清空所有或删除某条浏览器历史记录条目的方法，而且从控制台输出的 <code>history</code> 对象无法看到浏览器的历史记录栈中的具体内容，但是可以看到 <code>history.length</code> 属性，它标明了当前历史记录栈的个数。关于History API对历史记录栈的影响，<a href="https://www.cnblogs.com/accordion/p/5699372.html" target="_blank" rel="noopener noreferrer">有篇博客<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>做过测试，可以参考一下其测试实例：
<img src="/assets/img/testExp.bda306f1.png" alt="History API对历史记录栈的影响"></p> <blockquote><p>上图为测试实例。其中白色箭头意味着点击该链接并执行pushState操作，黑色箭头则执行浏览器后退，红色的圆点为历史记录栈中的当前指针，而每个项则为历史记录栈，历史记录的个数则为其子项的数量。实验结果表明浏览器针对每个页面维护一个History栈。执行pushState函数可压入设定的url至栈顶，同时修改当前指针；当执行back操作时，history栈大小并不会改变（history.length不变），仅仅移动当前指针的位置；若当前指针在history栈的中间位置（非栈顶），此时执行pushState会改变history栈的大小。</p></blockquote> <h3 id="_4、总结"><a href="#_4、总结" class="header-anchor">#</a> 4、总结</h3> <p>回到需要实现的功能上来：在移动端浏览器上，当页面返回时弹出提示框，点击<kbd>确认</kbd>时退出，点击<kbd>取消</kbd>时不退出，通过上面的分析，我们可以在刚进入页面时就使用 <code>history.pushState()</code> 方法增加一个页面并跳转到这个页面（不会刷新）。然后在 <code>window</code> 上绑定 <code>popstate</code> 事件，当用户操作返回时浏览器的记录栈指针会向前移动一个页面，在新的这个页面显示弹窗（由于页面不会刷新，所以视觉感受就是在本页面弹出弹窗），当选择<kbd>确认</kbd>时可以调用 <code>history.back()</code> 方法再次向前移动（或者其他逻辑），而选择<kbd>取消</kbd>时则可以重新调用 <code>history.pushState()</code> 方法，由于此时的指针不是在栈顶，所以会清除掉插入页面后面的页面（插入页面到栈顶的其他页面），保证下一次触发返回时还能弹出弹窗，而不是直接退出。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blogs_works/uploadFile.html" class="prev">
        前端文件上传
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.046e486f.js" defer></script><script src="/assets/js/2.cb9b70d5.js" defer></script><script src="/assets/js/4.d3a55895.js" defer></script>
  </body>
</html>
